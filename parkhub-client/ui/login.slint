// Login Screen

import { Theme } from "theme.slint";
import { Tr } from "i18n.slint";
import { LineEdit } from "std-widgets.slint";

export struct DevUser {
    id: string,
    email: string,
    name: string,
    initial: string,  // First letter of name for avatar
    role: string,
    color: color,
}

export component LoginScreen inherits Rectangle {
    background: Theme.background;

    // Properties
    in property <bool> is-loading: false;
    in property <string> error-message: "";
    in property <bool> dev-mode-enabled: true;
    in property <[DevUser]> dev-users: [];
    in property <string> server-mode: "local";  // "local" or "production"
    in property <string> server-url: "http://localhost:3000";
    in property <bool> show-register: false;
    in-out property <string> username: "";
    in-out property <string> password: "";
    in-out property <string> register-email: "";
    in-out property <string> register-name: "";

    // Callbacks
    callback login(string, string);  // username, password
    callback register(string, string, string, string);  // username, password, email, name
    callback toggle-register();
    callback google-login();
    callback dev-login(string);  // user id
    callback toggle-server-mode();

    VerticalLayout {
        alignment: center;
        spacing: Theme.spacing-lg;
        padding: Theme.spacing-xl;

        // Logo and Title
        VerticalLayout {
            alignment: center;
            spacing: Theme.spacing-md;

            // Logo circle with parking icon
            Rectangle {
                width: 100px;
                height: 100px;
                border-radius: 50px;
                background: Theme.primary;

                Text {
                    text: "P";
                    font-size: 50px;
                    font-weight: 700;
                    color: Theme.on-primary;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }

            Text {
                text: Tr.login-title;
                font-size: Theme.font-size-2xl;
                font-weight: 700;
                color: Theme.text-primary;
                horizontal-alignment: center;
            }

            Text {
                text: root.show-register ? "Create your account" : "Sign in to continue";
                font-size: Theme.font-size-md;
                color: Theme.text-secondary;
                horizontal-alignment: center;
            }
        }

        // Error message
        if root.error-message != "" : Rectangle {
            height: 44px;
            max-width: 320px;
            background: Theme.error.transparentize(0.9);
            border-radius: Theme.radius-md;

            Text {
                text: root.error-message;
                font-size: Theme.font-size-sm;
                color: Theme.error;
                horizontal-alignment: center;
                vertical-alignment: center;
                wrap: word-wrap;
            }
        }

        // Login/Register Form
        VerticalLayout {
            spacing: Theme.spacing-md;
            max-width: 320px;

            // Username field
            VerticalLayout {
                spacing: 4px;

                Text {
                    text: "Username";
                    font-size: Theme.font-size-sm;
                    font-weight: 500;
                    color: Theme.text-secondary;
                }

                Rectangle {
                    height: 48px;
                    background: Theme.surface;
                    border-radius: Theme.radius-md;
                    border-width: 1px;
                    border-color: Theme.border;

                    LineEdit {
                        x: 12px;
                        width: parent.width - 24px;
                        height: parent.height;
                        text <=> root.username;
                        placeholder-text: "Enter username";
                        font-size: 14px;
                    }
                }
            }

            // Password field
            VerticalLayout {
                spacing: 4px;

                Text {
                    text: "Password";
                    font-size: Theme.font-size-sm;
                    font-weight: 500;
                    color: Theme.text-secondary;
                }

                Rectangle {
                    height: 48px;
                    background: Theme.surface;
                    border-radius: Theme.radius-md;
                    border-width: 1px;
                    border-color: Theme.border;

                    LineEdit {
                        x: 12px;
                        width: parent.width - 24px;
                        height: parent.height;
                        text <=> root.password;
                        placeholder-text: "Enter password";
                        font-size: 14px;
                        input-type: InputType.password;
                    }
                }
            }

            // Register fields (only shown when registering)
            if root.show-register : VerticalLayout {
                spacing: Theme.spacing-md;

                // Email field
                VerticalLayout {
                    spacing: 4px;

                    Text {
                        text: "Email";
                        font-size: Theme.font-size-sm;
                        font-weight: 500;
                        color: Theme.text-secondary;
                    }

                    Rectangle {
                        height: 48px;
                        background: Theme.surface;
                        border-radius: Theme.radius-md;
                        border-width: 1px;
                        border-color: Theme.border;

                        LineEdit {
                            x: 12px;
                            width: parent.width - 24px;
                            height: parent.height;
                            text <=> root.register-email;
                            placeholder-text: "your@email.com";
                            font-size: 14px;
                        }
                    }
                }

                // Name field
                VerticalLayout {
                    spacing: 4px;

                    Text {
                        text: "Full Name";
                        font-size: Theme.font-size-sm;
                        font-weight: 500;
                        color: Theme.text-secondary;
                    }

                    Rectangle {
                        height: 48px;
                        background: Theme.surface;
                        border-radius: Theme.radius-md;
                        border-width: 1px;
                        border-color: Theme.border;

                        LineEdit {
                            x: 12px;
                            width: parent.width - 24px;
                            height: parent.height;
                            text <=> root.register-name;
                            placeholder-text: "John Doe";
                            font-size: 14px;
                        }
                    }
                }
            }

            // Submit Button
            Rectangle {
                height: 52px;
                border-radius: Theme.radius-lg;
                background: login-touch.has-hover ? Theme.primary.darker(10%) : Theme.primary;

                login-touch := TouchArea {
                    enabled: !root.is-loading && root.username != "" && root.password != "";
                    clicked => {
                        if (root.show-register) {
                            root.register(root.username, root.password, root.register-email, root.register-name);
                        } else {
                            root.login(root.username, root.password);
                        }
                    }
                    mouse-cursor: self.enabled ? pointer : default;
                }

                HorizontalLayout {
                    alignment: center;
                    spacing: Theme.spacing-sm;

                    if root.is-loading : Text {
                        text: "...";
                        font-size: Theme.font-size-lg;
                        color: Theme.on-primary;
                        vertical-alignment: center;
                    }

                    Text {
                        text: root.is-loading ? "Please wait..." : (root.show-register ? "Create Account" : "Sign In");
                        font-size: Theme.font-size-md;
                        font-weight: 600;
                        color: Theme.on-primary;
                        vertical-alignment: center;
                    }
                }
            }

            // Toggle Login/Register
            HorizontalLayout {
                alignment: center;
                spacing: 4px;

                Text {
                    text: root.show-register ? "Already have an account?" : "Don't have an account?";
                    font-size: Theme.font-size-sm;
                    color: Theme.text-secondary;
                    vertical-alignment: center;
                }

                Rectangle {
                    width: toggle-text.preferred-width + 8px;
                    height: 24px;

                    toggle-touch := TouchArea {
                        clicked => { root.toggle-register(); }
                        mouse-cursor: pointer;
                    }

                    toggle-text := Text {
                        text: root.show-register ? "Sign In" : "Register";
                        font-size: Theme.font-size-sm;
                        font-weight: 600;
                        color: Theme.primary;
                        vertical-alignment: center;
                        horizontal-alignment: center;
                    }
                }
            }
        }

        // Divider
        HorizontalLayout {
            alignment: center;
            spacing: Theme.spacing-sm;
            max-width: 320px;

            Rectangle {
                height: 1px;
                horizontal-stretch: 1;
                background: Theme.text-tertiary.transparentize(0.7);
            }

            Text {
                text: "Connected to server";
                font-size: Theme.font-size-xs;
                color: Theme.text-tertiary;
            }

            Rectangle {
                height: 1px;
                horizontal-stretch: 1;
                background: Theme.text-tertiary.transparentize(0.7);
            }
        }

        // Server Info
        Rectangle {
            height: 36px;
            max-width: 320px;
            border-radius: Theme.radius-md;
            background: Theme.surface;

            HorizontalLayout {
                alignment: center;
                spacing: Theme.spacing-sm;
                padding: Theme.spacing-sm;

                Rectangle {
                    width: 10px;
                    height: 10px;
                    border-radius: 5px;
                    background: Theme.secondary;
                }

                Text {
                    text: root.server-url;
                    font-size: Theme.font-size-sm;
                    color: Theme.text-secondary;
                    vertical-alignment: center;
                }
            }
        }

        // Footer
        Text {
            text: "ParkHub v0.1.0";
            font-size: Theme.font-size-xs;
            color: Theme.text-tertiary;
            horizontal-alignment: center;
        }
    }
}
